// TagFun
/***
 * Take a string, read some tags,
 * Replace their content with function's output
 * 
 * ### Example
 * var tg1 = '{{'; // Open tag
 * var tg2 = '}}'; // Close tag
 * var tpl = '{{2+2}} is a number'; // Template
 * var str = tagFun(tpl, tg1, tg2, function(c){
 *     return eval(c);
 * });
 * console.log(str);
 * */
function tagfun(str, tg1, tg2, fun) {
    // escape regex chars
    if (tg1 && tg2) {
        // escape dollar signs
        var ds = '__TAGFUNDSG__';
        str = str.replace(/\$/gim, ds);
        tg1 = tg1.replace(/\$/gim, ds);
        tg2 = tg2.replace(/\$/gim, ds);
        // escape regex chars
        var rx = /[|\\{}()[\]^$+*?.-]/gm;
        var t1 = tg1.replace(rx, '\\$&');
        var t2 = tg2.replace(rx, '\\$&');
        // match tags
        rx = t1+'[\\s\\S]*?'+t2;
        rx = new RegExp(rx,'gim');
        var m = str.match(rx);
        // replace tags
        if (m) { m.forEach(function(a){
            var b = '';
            rx = new RegExp('^'+t1,'gim');
            b = a.replace(rx, '');
            rx = new RegExp(t2+'$','gim');
            b = b.replace(rx, '');
            str = str.replace(a, fun(b), str);
        }); str = tagfun(str, tg1, tg2, fun)};
        // restore dollar signs
        rx = new RegExp(ds, 'gim');
        str = str.replace(rx, '$$');
    } return str;
}
